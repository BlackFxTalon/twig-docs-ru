<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="robots" content="index, follow, all"/>
  <meta name="Author" content="SensioLabs"/>
  <meta name="Language" content="ru"/>
  <meta name="Copyright" content="Sensio"/>
  <meta name="Publisher" content="Sensio"/>
  <meta name="Description" content="Twig - The flexible, fast, and secure template engine for PHP"/>
  <meta name="Keywords" content="twig, templating, template, engine, template engine, template language, php"/>

  <title>Twig Internals - Documentation - Twig - The flexible, fast, and secure PHP template engine</title>

  <link href="../../css/reset-min.css" rel="stylesheet" type="text/css"/>
  <link href="../../css/base.css" rel="stylesheet" type="text/css"/>
  <link href="../../css/colors.css" rel="stylesheet" type="text/css"/>
  <link href="../../css/code.css" rel="stylesheet" type="text/css"/>
  <link href="../../css/pygments.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript">     var _gaq = _gaq || [];   </script>
</head>
<body>
<a href="https://github.com/ruden/twig-docs-ru"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
<div id="sln"></div>
<div class="hd">
  <div class="illustration png_fix">
    <div class="content">
      <div class="sensio_product">
        <img class="png_fix" src="../../images/sensio-labs-product.svg" alt="a SensioLabs Product" height="18"/>
      </div>
      <div class="clearfix">
        <div class="logo_header"><a href="/twig-docs-ru/">Twig</a></div>
        <h1 class="title_header">
          Гибкий, быстрый и безопасный<br/>шаблонизатор для PHP
        </h1>
      </div>

      <div class="menu">
        <ul>
          <li><a href="/twig-docs-ru/">О TWIG</a></li>
          <li><a class="active" href="/twig-docs-ru/doc/2.x/">ДОКУМЕНТАЦИЯ</a></li>
          <li><a href="/twig-docs-ru/development.html">РАЗРАБОТКА</a></li>
          <li><a href="/twig-docs-ru/contributors.html">УЧАСТНИКИ</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>
<div class="bd">
  <div class="content">
    <div class="alert">

      You are reading the documentation for Twig 2.x.

      Switch to the documentation for Twig
      <a href="/doc/1.x/">1.x</a>.
    </div>


    <div class="infobar clearfix">
      <div id="doc-toc" class="infobar-box">
        <h3>Table of Contents</h3>
        <ul>
          <li><a class="reference internal" href="#">Twig Internals</a>
            <ul>
              <li><a class="reference internal" href="#how-does-twig-work">How does Twig work?</a></li>
              <li><a class="reference internal" href="#the-lexer">The Lexer</a></li>
              <li><a class="reference internal" href="#the-parser">The Parser</a></li>
              <li><a class="reference internal" href="#the-compiler">The Compiler</a></li>
            </ul>
          </li>
        </ul>

      </div>

      <div class="infobar-box">
        <h3>Questions &amp; Feedback</h3>
        <div class="feedback">
          <p>
            <strong>Found a typo or an error?</strong><br/>
            Want to improve this document?
            <a href="https://github.com/twigphp/Twig/edit/2.x/doc/internals.rst">Edit</a> it.
          </p>
          <p>
            <strong>Need support or have a technical question?</strong><br/>
            Ask support on <a href="https://stackoverflow.com/">Stack Overflow</a>.
          </p>
        </div>

        <h3>License</h3>
        <div id="license">
          Twig
          <span href="https://purl.org/dc/dcmitype/MovingImage" rel="dc:type">documentation</span> is licensed under the
          new BSD <a href="/twig-docs-ru/license.html">License</a>.
        </div>
      </div>
    </div>

    <div class="body-web">
      <div class="section" id="twig-internals">
        <h1>Twig Internals<a class="headerlink" href="#twig-internals" title="Permalink to this headline">¶</a></h1>
        <p>Twig is very extensible and you can easily hack it. Keep in mind that you
          should probably try to create an extension before hacking the core, as most
          features and enhancements can be handled with extensions. This chapter is also
          useful for people who want to understand how Twig works under the hood.</p>
        <div class="section" id="how-does-twig-work">
          <h2>How does Twig work?<a class="headerlink" href="#how-does-twig-work" title="Permalink to this headline">¶</a>
          </h2>
          <p>The rendering of a Twig template can be summarized into four key steps:</p>
          <ul class="simple">
            <li><strong>Load</strong> the template: If the template is already compiled, load it and go
              to the <em>evaluation</em> step, otherwise:
              <ul>
                <li>First, the <strong>lexer</strong> tokenizes the template source code into small pieces
                  for easier processing;
                </li>
                <li>Then, the <strong>parser</strong> converts the token stream into a meaningful tree
                  of nodes (the Abstract Syntax Tree);
                </li>
                <li>Eventually, the <em>compiler</em> transforms the AST into PHP code.</li>
              </ul>
            </li>
            <li><strong>Evaluate</strong> the template: It basically means calling the
              <code class="notranslate">display()</code>
              method of the compiled template and passing it the context.
            </li>
          </ul>
        </div>
        <div class="section" id="the-lexer">
          <h2>The Lexer<a class="headerlink" href="#the-lexer" title="Permalink to this headline">¶</a></h2>
          <p>The lexer tokenizes a template source code into a token stream (each token is
            an instance of <code class="notranslate">Twig_Token</code>, and the stream is an instance of
            <code class="notranslate">Twig_TokenStream</code>). The default lexer recognizes 13 different token types:
          </p>
          <ul class="simple">
            <li><code class="notranslate">Twig_Token::BLOCK_START_TYPE</code>,
              <code class="notranslate">Twig_Token::BLOCK_END_TYPE</code>: Delimiters for blocks (<code class="notranslate">{% %}</code>)
            </li>
            <li><code class="notranslate">Twig_Token::VAR_START_TYPE</code>,
              <code class="notranslate">Twig_Token::VAR_END_TYPE</code>: Delimiters for variables (<code class="notranslate">{{ }}</code>)
            </li>
            <li><code class="notranslate">Twig_Token::TEXT_TYPE</code>: A text outside an expression;</li>
            <li><code class="notranslate">Twig_Token::NAME_TYPE</code>: A name in an expression;</li>
            <li><code class="notranslate">Twig_Token::NUMBER_TYPE</code>: A number in an expression;</li>
            <li><code class="notranslate">Twig_Token::STRING_TYPE</code>: A string in an expression;</li>
            <li><code class="notranslate">Twig_Token::OPERATOR_TYPE</code>: An operator;</li>
            <li><code class="notranslate">Twig_Token::PUNCTUATION_TYPE</code>: A punctuation sign;</li>
            <li><code class="notranslate">Twig_Token::INTERPOLATION_START_TYPE</code>,
              <code class="notranslate">Twig_Token::INTERPOLATION_END_TYPE</code>: Delimiters for string interpolation;
            </li>
            <li><code class="notranslate">Twig_Token::EOF_TYPE</code>: Ends of template.</li>
          </ul>
          <p>You can manually convert a source code into a token stream by calling the
            <code class="notranslate">tokenize()</code> method of an environment:</p>
          <div class="literal-block notranslate">
            <div class="highlight-php">
              <div class="highlight"><pre><span></span><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">tokenize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Source</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$identifier</span><span class="p">));</span>
</pre>
              </div>
            </div>
          </div>
          <p>As the stream has a <code class="notranslate">__toString()</code> method, you can have a textual
            representation of it by echoing the object:</p>
          <div class="literal-block notranslate">
            <div class="highlight-php">
              <div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$stream</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre>
              </div>
            </div>
          </div>
          <p>Here is the output for the <code class="notranslate">Hello {{ name }}</code> template:</p>
          <div class="literal-block notranslate">
            <div class="highlight-text">
              <table class="highlighttable">
                <tr>
                  <td class="linenos">
                    <div class="linenodiv"><pre>1
2
3
4
5</pre>
                    </div>
                  </td>
                  <td class="code">
                    <div class="highlight"><pre><span></span>TEXT_TYPE(Hello )
VAR_START_TYPE()
NAME_TYPE(name)
VAR_END_TYPE()
EOF_TYPE()
</pre>
                    </div>
                  </td>
                </tr>
              </table>
            </div>
          </div>
          <div class="admonition-wrapper">
            <div class="note"></div>
            <div class="admonition admonition-note"><p class="first admonition-title">Note</p>
              <p>The default lexer (<code class="notranslate">Twig_Lexer</code>) can be changed by calling
                the <code class="notranslate">setLexer()</code> method:</p>
              <div class="literal-block notranslate">
                <div class="last highlight-php">
                  <div class="highlight"><pre><span></span><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">setLexer</span><span class="p">(</span><span class="nv">$lexer</span><span class="p">);</span>
</pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="section" id="the-parser">
          <h2>The Parser<a class="headerlink" href="#the-parser" title="Permalink to this headline">¶</a></h2>
          <p>The parser converts the token stream into an AST (Abstract Syntax Tree), or a
            node tree (an instance of <code class="notranslate">Twig_Node_Module</code>). The core extension defines
            the basic nodes like: <code class="notranslate">for</code>,
            <code class="notranslate">if</code>, ... and the expression nodes.</p>
          <p>You can manually convert a token stream into a node tree by calling the
            <code class="notranslate">parse()</code> method of an environment:</p>
          <div class="literal-block notranslate">
            <div class="highlight-php">
              <div class="highlight"><pre><span></span><span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">(</span><span class="nv">$stream</span><span class="p">);</span>
</pre>
              </div>
            </div>
          </div>
          <p>Echoing the node object gives you a nice representation of the tree:</p>
          <div class="literal-block notranslate">
            <div class="highlight-php">
              <div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$nodes</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre>
              </div>
            </div>
          </div>
          <p>Here is the output for the <code class="notranslate">Hello {{ name }}</code> template:</p>
          <div class="literal-block notranslate">
            <div class="highlight-text">
              <table class="highlighttable">
                <tr>
                  <td class="linenos">
                    <div class="linenodiv"><pre>1
2
3
4
5
6</pre>
                    </div>
                  </td>
                  <td class="code">
                    <div class="highlight"><pre><span></span>Twig_Node_Module(
  Twig_Node_Text(Hello )
  Twig_Node_Print(
    Twig_Node_Expression_Name(name)
  )
)
</pre>
                    </div>
                  </td>
                </tr>
              </table>
            </div>
          </div>
          <div class="admonition-wrapper">
            <div class="note"></div>
            <div class="admonition admonition-note"><p class="first admonition-title">Note</p>
              <p>The default parser (<code class="notranslate">Twig_TokenParser</code>) can be changed by calling the
                <code class="notranslate">setParser()</code> method:</p>
              <div class="literal-block notranslate">
                <div class="last highlight-php">
                  <div class="highlight"><pre><span></span><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">setParser</span><span class="p">(</span><span class="nv">$parser</span><span class="p">);</span>
</pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="section" id="the-compiler">
          <h2>The Compiler<a class="headerlink" href="#the-compiler" title="Permalink to this headline">¶</a></h2>
          <p>The last step is done by the compiler. It takes a node tree as an input and
            generates PHP code usable for runtime execution of the template.</p>
          <p>You can manually compile a node tree to PHP code with the <code class="notranslate">compile()</code> method
            of an environment:</p>
          <div class="literal-block notranslate">
            <div class="highlight-php">
              <div class="highlight"><pre><span></span><span class="nv">$php</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">compile</span><span class="p">(</span><span class="nv">$nodes</span><span class="p">);</span>
</pre>
              </div>
            </div>
          </div>
          <p>The generated template for a <code class="notranslate">Hello {{ name }}</code> template reads as follows
            (the actual output can differ depending on the version of Twig you are
            using):</p>
          <div class="literal-block notranslate">
            <div class="highlight-php">
              <table class="highlighttable">
                <tr>
                  <td class="linenos">
                    <div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre>
                    </div>
                  </td>
                  <td class="code">
                    <div class="highlight"><pre><span></span><span class="cm">/* Hello {{ name }} */</span>
<span class="k">class</span> <span class="nc">__TwigTemplate_1121b6f109fe93ebe8c6e22e3712bceb</span> <span class="k">extends</span> <span class="nx">Twig_Template</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">doDisplay</span><span class="p">(</span><span class="k">array</span> <span class="nv">$context</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$blocks</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">// line 1</span>
        <span class="k">echo</span> <span class="s2">&quot;Hello &quot;</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nx">twig_escape_filter</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">env</span><span class="p">,</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$context</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">),</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// some more code</span>
<span class="p">}</span>
</pre>
                    </div>
                  </td>
                </tr>
              </table>
            </div>
          </div>
          <div class="admonition-wrapper">
            <div class="note"></div>
            <div class="admonition admonition-note"><p class="first admonition-title">Note</p>
              <p>The default compiler (<code class="notranslate">Twig_Compiler</code>) can be changed by calling the
                <code class="notranslate">setCompiler()</code> method:</p>
              <div class="literal-block notranslate">
                <div class="last highlight-php">
                  <div class="highlight"><pre><span></span><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">setCompiler</span><span class="p">(</span><span class="nv">$compiler</span><span class="p">);</span>
</pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="navigation">
      <a accesskey="P" title="Extending Twig" href="advanced.html">
        &laquo;&nbsp;Extending Twig
      </a>
      <span class="separator">|</span> <a accesskey="N" title="Recipes" href="recipes.html">
      Recipes&nbsp;&raquo;
    </a>
    </div>
  </div>
  <div class="ft">
    <div class="content">
      The Twig <a href="images/twig-logo.png">logo</a> is &copy; 2010-2018
      <a target="_blank" href="https://sensiolabs.com/" class="sensiolabs">Sensio<span class="brand">Labs</span></a>
    </div>
  </div>
</div>
</body>
</html>
